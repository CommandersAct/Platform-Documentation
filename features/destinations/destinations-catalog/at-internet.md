# Piano Analytics (AT Internet)

[Piano Analytics](https://developers.atinternet-solutions.com/piano-analytics/#what-is-piano-analytics) is the successor of AT Internet Analytics Suite 2 (AS2).\
It's a user-centric tool that simplifies product & marketing analytics, while ensuring data quality.\
Your data will be sent server-side getting the most from Piano Analytics' [Collection API](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api) and in form of [events](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/standard-events).

{% hint style="info" %}
The [Collection API](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api) is only available for [Piano Analytics](https://developers.atinternet-solutions.com/piano-analytics/#what-is-piano-analytics).\
You can check the following [compatibility table](https://developers.atinternet-solutions.com/piano-analytics/#before-i-start) to get more insights on supported features by product.
{% endhint %}

## Key features

The Piano Analytics destination provides the following key features:

* **Events structure**: our [Events reference](https://community.commandersact.com/platform-x/developers/tracking/events-reference) matches [Piano Analytics' one](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/standard-events), meaning that your data is properly bridged to the expected fields in an optimized way.
* **Prebuilt mappings**: data mapping for event-based destinations happens automatically, which simplifies user inputs.
* **Custom events**: you can freely push custom events based on your specific needs.
* **Support for multi-item data**: information included in the [item](https://community.commandersact.com/platform-x/developers/tracking/events-reference#item) array is dispatched to Piano Analytics.
* **User identifier**: you can openly select a user identifier field for logged users.
* **Send all properties**: send all your event properties to Piano Analytics with a single click.

## Destination setup

Before you get started with this destination, ensure you have access to [Piano Analytics](https://developers.atinternet-solutions.com/piano-analytics/#what-is-piano-analytics).

{% hint style="info" %}
The client-side unique visitor identifier is recommended and is retrieved by getting the value of the[**`_pcid`**](https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/cookie-storage#since-670)**,**[**`pa_vid`**](https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/cookie-storage#piano-analytics-mobile-sdks),[**`atuserid`**](https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/cookie-storage#legacy-cookie-management), or<mark style="color:blue;">**`xtidc`**</mark>cookie in this priority order.
{% endhint %}

### Configuration

| Settings                    | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Side Id`                   | <p><em><strong><code>Required</code></strong></em></p><p>The identifier of the site the data belongs to (E.g. <code>628087</code>). This can be found in the Piano Analytics interface following <img src="../../../.gitbook/assets/1 (3).png" alt=""> ➜ <code>SETTINGS</code> ➜ <code>Data Collection Portal</code> ➜ <code>Tools</code> ➜ <code>Site Management</code> and selecting your site.</p>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `Secured Collection Domain` | <p><em><strong><code>Required</code></strong></em></p><p>The SSL Domain on which information is collected (E.g. <code>logs1412.xiti.com</code>). This can be found in Piano Analytics interface following <img src="../../../.gitbook/assets/1 (3).png" alt=""> ➜ <code>SETTINGS</code><br><code>Data Collection Portal</code> ➜ <code>Tools</code> ➜ <code>Site Management</code> and selecting your site.</p>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `User Identifier`           | You can set your user identifier for logged users. More details are available following this [LINK](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api#users).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `Custom Property`           | When selecting "\[Custom Property]" as value for the above `User Identifier`, this field will show up so you can specify a custom field holding the value for the user identifier **\[1]**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `Client Identifier`         | You can set a specific client identifier as our `context.device.sdk_id` or a custom property holding its value. When keeping the "Default" value, or the first mentioned options don't result in a valid value, this is your client-side unique visitor identifier from cookies as detailed in the [Destination setup](at-internet.md#destination-setup). If no cookie is available, the property `user.tcId` is used. More details are available following this [LINK](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api#pattern-1).                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `Custom Property`           | When selecting "\[Custom Property]" as value for the above `Client Identifier`, this field will show up so you can specify a custom field holding the value for the client identifier **\[1]**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `Send All Properties`       | When activating this option all properties included in the root of your Commanders Act events are also sent to Piano Analytics in the `data` object. More details are available following this [LINK](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api#event-object).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `Custom Event Properties`   | <p>Map your custom event properties by setting their field names in <code>Event property name</code> and adding the field name holding the value in <code>Commanders Act event property or static value</code>. E.g. if you input<code>size</code>in the <code>Event property name</code> and <code>properties.items.0.product.size</code> in <code>Commanders Act event property or static value</code>, you'll have a custom event property in Piano Analytics called<code>size</code>with a value based on the content of the field <code>properties.items.0.product.size</code> <strong>[1]</strong>. You also have the option to set a static string/numeric value in <code>Commanders Act event property or static value</code>.<br><br>To ensure that custom event properties are picked up by Piano Analytics, you need to create them first by following <img src="../../../.gitbook/assets/1 (3).png" alt=""> ➜ <code>SETTINGS</code> ➜ <code>Data Management</code> ➜ <code>Data Model</code> ➜<code>Properties</code>.</p> |
| `Custom User Properties`    | <p>Map your custom user properties by setting their field names in <code>User property name</code> and adding the field name holding the value in <code>Commanders Act event property or static value</code>.<br>E.g. if you input<code>customer_zipcode</code>in <code>User property name</code> and<code>properties.user.zipcode</code> <strong>[1]</strong> in <code>Commanders Act event property or static value</code>, you will have a custom user property in GA4 called<code>customer_zipcode</code>with a value based on the content of the field<code>properties.user.zipcode</code>. You also have the option to set a static string/numeric value in <code>Commanders Act event property or static value</code>.<br></p><p>To ensure that custom user properties are picked up by Piano Analytics, you need to create them first by following <img src="../../../.gitbook/assets/1 (3).png" alt=""> ➜ <code>SETTINGS</code> ➜ <code>Data Management</code> ➜ <code>Data Model</code> ➜<code>Properties</code>.</p>        |

{% hint style="info" %}
**\[1]** Using "dots" (".") you can navigate deeper to the specific field you want to get the value of. See [Events reference](https://community.commandersact.com/platform-x/developers/tracking/events-reference) for more details on the standard field names by event. You can also freely set custom fields: there are no boundaries.
{% endhint %}

## Quick reference

| Commanders Act Events | Piano Analytics Events                                      |
| --------------------- | ----------------------------------------------------------- |
| `add_payment_info`    | `cart.payment`                                              |
| `add_shipping_info`   | `cart.delivery`                                             |
| `add_to_cart`         | `product.add_to_cart`                                       |
| `add_to_wishlist`     | `product.add_to_wishlist` **\[\*]**                         |
| `begin_checkout`      | `cart.begin_checkout` **\[\*]**                             |
| `generate_lead`       | `generate_lead` **\[\*]**                                   |
| `login`               | `user.login` **\[\*]**                                      |
| `page_view`           | `page.display` or `product.page_display` **\[1]**           |
| `purchase`            | `transaction.confirmation` and `product.purchased` **\[2]** |
| `refund`              | `refund` **\[\*]**                                          |
| `remove_from_cart`    | `product.remove_from_cart`                                  |
| `search`              | `internal_search_result.display`                            |
| `select_content`      | `select_content` **\[\*]**                                  |
| `select_item`         | `page.select_item` **\[\*]**                                |
| `sign_up`             | `user.sign_up` **\[\*]**                                    |
| `view_cart`           | `cart.display`                                              |
| `view_item`           | `product.display`                                           |
| `view_item_list`      | `page.view_item_list` **\[\*]**                             |
| `[Custom Event]`      | `[Custom Event]` **\[\*]**                                  |

{% hint style="info" %}
**\[\*]** Custom events must be added to the Piano Analytics' data model first or they won't be processed. You can add new events by following ![](<../../../.gitbook/assets/1 (3).png>) ➜ `SETTINGS` ➜ `Data Management` ➜ `Data Model` ➜`Events`.\
**\[1]** If<mark style="color:blue;">`properties.page_type`</mark>is equal to<mark style="color:blue;">`product`</mark>then<mark style="color:blue;">`product.page_display`</mark>is sent, otherwise,<mark style="color:blue;">`page.display`</mark>.\
**\[2]** A<mark style="color:blue;">`product.purchased`</mark>will be sent for each product being purchased.
{% endhint %}

## Field mappings

| Commanders Act Properties                                                                                                                                                                                         | Piano Analytics Properties                                                                                      |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| `properties.page_name`                                                                                                                                                                                            | `page`                                                                                                          |
| `properties.value`                                                                                                                                                                                                | <p><code>generate_lead_value</code></p><p><code>cart_turnovertaxincluded</code></p>                             |
| `properties.currency`                                                                                                                                                                                             | <p><code>generate_lead_currency</code></p><p><code>cart_currency</code></p>                                     |
| `properties.id`                                                                                                                                                                                                   | <p><code>transaction_id</code></p><p><code>generate_lead_id</code></p>                                          |
| `properties.item_list_name`                                                                                                                                                                                       | `view_item_list_name`                                                                                           |
| `properties.method`                                                                                                                                                                                               | <p><code>login_method</code></p><p><code>sign_up_method</code></p>                                              |
| `properties.search_term`                                                                                                                                                                                          | `ise_keyword`                                                                                                   |
| `properties.items.X.id`                                                                                                                                                                                           | `product_id` **\[1]**                                                                                           |
| `properties.items.X.product.name`                                                                                                                                                                                 | `product` **\[1]**                                                                                              |
| `properties.items.X.variant`                                                                                                                                                                                      | `product_variant` **\[1]**                                                                                      |
| `properties.items.X.product.brand`                                                                                                                                                                                | `product_brand` **\[1]**                                                                                        |
| `(properties.items.X.discount > 0)`                                                                                                                                                                               | `product_discount` **\[1]\[2]**                                                                                 |
| `properties.items.X.product.price`                                                                                                                                                                                | `product_pricetaxincluded` **\[1]**                                                                             |
| `properties.items.X.product.currency`                                                                                                                                                                             | `product_currency` **\[1]**                                                                                     |
| `properties.items.X.product.category_1`                                                                                                                                                                           | `product_category1` **\[1]**                                                                                    |
| `properties.items.X.product.category_2`                                                                                                                                                                           | `product_category2` **\[1]**                                                                                    |
| `properties.items.X.product.category_3`                                                                                                                                                                           | `product_category3` **\[1]**                                                                                    |
| `properties.items.X.product.category_4`                                                                                                                                                                           | `product_category4` **\[1]**                                                                                    |
| `properties.items.X.quantity`                                                                                                                                                                                     | <p><code>product_quantity</code> <strong>[1]</strong></p><p><code>cart_quantity</code> <strong>[3]</strong></p> |
| `properties.items.X.coupon`                                                                                                                                                                                       | `product_promocode` **\[1]**                                                                                    |
| `properties.coupon`                                                                                                                                                                                               | `transaction_promocode`                                                                                         |
| `properties.payment_method`                                                                                                                                                                                       | `payment_mode`                                                                                                  |
| `properties.shipping_amount`                                                                                                                                                                                      | `shipping_costtaxincluded`                                                                                      |
| `properties.shipping_tier`                                                                                                                                                                                        | `shipping_delivery`                                                                                             |
| `properties.cart_id`                                                                                                                                                                                              | `cart_id`                                                                                                       |
| `properties.revenue`                                                                                                                                                                                              | `cart_turnovertaxfree`                                                                                          |
| `properties.items.length`                                                                                                                                                                                         | `cart_nbdistinctproduct`                                                                                        |
| <p><code>properties.user.id</code></p><p><code>properties.user.email</code></p><p><code>properties.user.email_md5</code></p><p><code>properties.user.email_sha256</code></p><p><code>[custom_property]</code></p> | `user_id` **\[4]**                                                                                              |
| `device.manufacturer`                                                                                                                                                                                             | `device_manufacturer`                                                                                           |
| `device.model`                                                                                                                                                                                                    | `device_model`                                                                                                  |
| `device.screen.height`                                                                                                                                                                                            | `device_screen_height`                                                                                          |
| `device.screen.width`                                                                                                                                                                                             | `device_screen_width`                                                                                           |

{% hint style="info" %}
**\[1]** Field included for the following events: <mark style="color:blue;">`add_to_cart`</mark>,<mark style="color:blue;">`page_view (product.page_display)`</mark>,<mark style="color:blue;">`view_item`</mark>,<mark style="color:blue;">`purchase (product.purchased)`</mark>, <mark style="color:blue;">`remove_from_cart`</mark>,<mark style="color:blue;">`add_to_wishlist`</mark>, and<mark style="color:blue;">`select_item`</mark>.\
**\[2]** Boolean value:<mark style="color:blue;">`true`</mark>or<mark style="color:blue;">`false`</mark>.\
**\[3]** Sum all<mark style="color:blue;">`properties.items.X.quantity`</mark>.\
**\[4]** Depending on the drop-down selection (See<mark style="color:blue;">`User Identifier`</mark>in the[<mark style="color:blue;">`Configuration`</mark>](at-internet.md#configuration)section), a specific Commanders Act property is used.
{% endhint %}

#### Headers parameters

| Commanders Act Properties | Piano Analytics Fields |
| ------------------------- | ---------------------- |
| `device.user_agent`       | `User-Agent`           |
| `page.location`           | `Referer`              |
| `device.ip`               | `X-Forwarded-For`      |
