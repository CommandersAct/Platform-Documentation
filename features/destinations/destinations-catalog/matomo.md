# Matomo

[Matomo](https://matomo.org/), formerly Piwik, is an open source web analytics application to track online visits to one or more websites and display reports on these visits for analysis.\
Using this destination you can implement server-side tracking using Matomo [Tracking HTTP API](https://developer.matomo.org/api-reference/tracking-api).

## Key features

The Matomo destination provides the following key features:

* **Events structure**: our [Events reference](https://community.commandersact.com/platform-x/developers/tracking/events-reference) covers [Matomo's request structure](https://developer.matomo.org/api-reference/tracking-api), meaning that your data is properly bridged to the expected fields in an optimized way.
* **Prebuilt mappings**: data mapping for event-based destinations happens automatically, which simplifies user inputs.
* **Automatic hashing**: information is automatically hashed matching partner specifications.
* **Custom events and properties**: you can freely push custom events and properties based on your specific needs.
* **Support for multi-item data**: information included in the [item ](https://community.commandersact.com/platform-x/developers/tracking/events-reference#item)array is bridged to Matomo.

## Destination setup

{% hint style="info" %}
Matomo recommends using custom parameters instead of custom variables as the latter are deprecated. The data for some Matomo optional fields will not be available in your app / technical layer which is expected, but you should provide as much information as you can.
{% endhint %}

### Configuration

<table><thead><tr><th width="315">Settings</th><th>Description</th></tr></thead><tbody><tr><td><code>Server Domain</code></td><td><p><em><strong><code>Required</code></strong></em></p><p>Your server domain as provided by Matomo. (E.g. for https://<mark style="color:blue;"><code>your-matomo-domain.example</code></mark>/matomo.php, include the blue string only).</p></td></tr><tr><td><code>Site Id</code></td><td><p><em><strong><code>Required</code></strong></em></p><p>Your site identifier as provided by Matomo. More details are available following this <a href="https://matomo.org/faq/general/faq_19212/">LINK</a>.</p></td></tr><tr><td><code>Visitor Id Cookie Name</code></td><td>Cookie name holding a few details about the user such as the unique visitor identifier. It normally starts with the string <code>_pk_id</code>. This has priority over the following field <code>Visitor Id Value</code> . More details are available following this <a href="https://matomo.org/faq/general/faq_146/">LINK</a>. (E.g. value "4e4eb04b31f37eac.1653656637.")</td></tr><tr><td><code>Visitor Id Value</code></td><td>The unique visitor identifier value if you need to pass it without a cookie.</td></tr><tr><td><code>User Identifier</code></td><td>You can bridge your selected user identifier for logged users. More details are available following this <a href="https://matomo.org/guide/reports/user-ids/">LINK</a>.</td></tr><tr><td><code>Matomo Custom Variables</code></td><td>Map your Matomo custom variables by setting their field names in <code>Custom Variable Name</code> and adding the field name holding the value in <code>Commanders Act event property or static value</code>. E.g. if you input<code>size</code>in <code>Custom Variable Name</code> and <code>items.0.product.size</code> in <code>Commanders Act event property or static value</code>, you'll have a custom variable in Matomo called<code>size</code>with a value based on the content of the field <code>items.0.product.size</code> <strong>[1]</strong>. You also have the option to set a static string/numeric value in <code>Commanders Act event property or static value</code>.<br><br>More details on custom variables are available following this <a href="https://matomo.org/faq/how-to/guide-to-using-custom-variables-deprecated/">LINK</a>.</td></tr><tr><td><code>Matomo Custom Parameters</code></td><td>Map your Matomo custom parameters by setting their field names in <code>Custom Parameter Name</code> and adding the field name holding the value in <code>Commanders Act event property or static value</code>. E.g. if you input<code>size</code>in <code>Custom Parameter Name</code> and <code>items.0.product.size</code> in <code>Commanders Act event property or static value</code>, you'll have a custom parameter in Matomo called<code>size</code>with a value based on the content of the field <code>items.0.product.size</code> <strong>[1]</strong>. You also have the option to set a static string/numeric value in <code>Commanders Act event property or static value</code>.<br><br>More details on custom parameters/dimensions are available following this <a href="https://matomo.org/guide/reporting-tools/custom-dimensions/">LINK</a>.</td></tr><tr><td><code>Matomo Goals</code></td><td>Map your Matomo goals by setting the <code>Commanders Act Event Name</code> in the related field and the <code>Matomo Goal Id</code> associated with it.<br><br>More details on goals are available following this <a href="https://matomo.org/guide/reports/goals-and-conversions/">LINK</a>.</td></tr><tr><td><code>Authorization Token</code></td><td>An <a href="https://matomo.org/faq/general/faq_114/">authorization token</a> is required to send additional parameters. Going to Matomo's interface, It's recommend to create a user specifically for accessing the "Tracking API", and give the user <strong>only </strong><em><strong>write</strong></em><strong> permission</strong> on the website(s). More details on the additional parameters are available following this <a href="https://developer.matomo.org/api-reference/tracking-api#other-parameters-require-authentication-via-token_auth">LINK</a>.</td></tr></tbody></table>



{% hint style="info" %}
**\[1]** Using "dots" (".") you can navigate deeper to the specific field you want to get the value of. See [Events reference](https://community.commandersact.com/platform-x/developers/tracking/events-reference) for more details on the standard field names by event. You can also freely set custom fields: there are no boundaries.
{% endhint %}

## Field mappings

{% hint style="info" %}
Matomo property<mark style="color:blue;">`e_c`</mark>is statically set with<mark style="color:blue;">`ca_event`</mark>.\
Ecommerce parameters are passed for incoming [purchase](https://community.commandersact.com/platform-x/developers/tracking/events-reference#purchase) events.&#x20;
{% endhint %}

| Commanders Act Properties                                                                                                                                                                                                              | Matomo Properties                                                             |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| `Site Id`                                                                                                                                                                                                                              | `idsite`                                                                      |
| `event_name`                                                                                                                                                                                                                           | <p><code>action_name</code></p><p><code>e_a</code></p><p><code>e_n</code></p> |
| `value`                                                                                                                                                                                                                                | <p><code>e_v</code></p><p><code>revenue</code></p>                            |
| `page.location`                                                                                                                                                                                                                        | `url`                                                                         |
| `device.user_agent`                                                                                                                                                                                                                    | `ua`                                                                          |
| <p><code>Visitor Id Cookie Name</code></p><p><code>Visitor Id Value</code></p>                                                                                                                                                         | `_id` **\[1]**                                                                |
| `page.referrer`                                                                                                                                                                                                                        | `urlref`                                                                      |
| `Matomo Custom Variables`                                                                                                                                                                                                              | `_cvars`                                                                      |
| <p><code>user.id</code></p><p><code>user.email</code></p><p><code>user.email_md5</code></p><p><code>user.email_sha256</code></p><p><code>[custom_property]</code></p>                                                                  | `uid` **\[2]**                                                                |
| `search_term`                                                                                                                                                                                                                          | `search`                                                                      |
| `Matomo Goals`                                                                                                                                                                                                                         | `idgoal` **\[3]**                                                             |
| `id`                                                                                                                                                                                                                                   | `ec_id`                                                                       |
| \[\[`items.0.id`,`items.0.product.name`,`items.0.product.category_1`,`items.0.product.price`,`items.0.quantity`],`...`,\[`items.N.id`,`items.N.product.name`,`items.N.product.category_1`,`items.N.product.price`,`items.N.quantity`]] | `ec_items` **\[4]**                                                           |
| `revenue`                                                                                                                                                                                                                              | `ec_st`                                                                       |
| `tax_amount`                                                                                                                                                                                                                           | `ec_tx`                                                                       |
| `shipping_amount`                                                                                                                                                                                                                      | `ec_sh`                                                                       |
| `Authorization Token`                                                                                                                                                                                                                  | `token_auth`                                                                  |
| `device.ip`                                                                                                                                                                                                                            | `cip`                                                                         |
| `event_timestamp`                                                                                                                                                                                                                      | `cdt`                                                                         |

{% hint style="info" %}
**\[1]** If a cookie is not provided, this destination searches for a cookie name containing the string<mark style="color:blue;">`_pk_id`</mark>to retrieve the visitor identifier from it. Alternatively, you can pass the value using a datalayer property. See [Configuration ](matomo.md#configuration)for more details.\
**\[2]** Depending on the drop-down selection (See<mark style="color:blue;">`User Identifier`</mark>in[`Configuration`](matomo.md#configuration)), a specific Commanders Act property is used.\
**\[3]** Based on your configuration (See<mark style="color:blue;">`Matomo Goals`</mark>in the[`Configuration`](matomo.md#configuration)), a specific identifier is set in this field. With[`purchase`](https://community.commandersact.com/platform-x/developers/tracking/events-reference#purchase)events,<mark style="color:blue;">`0`</mark>is bridged as identifier. \
**\[4]** The resulting array is encoded.&#x20;
{% endhint %}
