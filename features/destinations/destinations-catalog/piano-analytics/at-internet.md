# Piano Analytics Collection API

[Piano Analytics](https://piano.io/) is the successor of AT Internet Analytics Suite 2 (AS2).\
It's a user-centric tool that simplifies product & marketing analytics, while ensuring data quality.\
Your data will be sent server-side getting the most from Piano Analytics' [Collection API](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api) and in form of [events](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/standard-events).

{% hint style="info" %}
The [Collection API](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api) is only available for [Piano Analytics](https://developers.atinternet-solutions.com/piano-analytics/#what-is-piano-analytics).\
You can check the following [compatibility table](https://developers.atinternet-solutions.com/piano-analytics/#before-i-start) to get more insights on supported features by product.
{% endhint %}

## Key features

The Piano Analytics Collection API destination provides the following key features:

* **Events structure**: our [Events reference](https://community.commandersact.com/platform-x/developers/tracking/events-reference) matches [Piano Analytics' one](https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/standard-events), meaning that your data is properly bridged to the expected fields in an optimized way.
* **Prebuilt mappings**: data mapping for event-based destinations happens automatically, which simplifies user inputs.
* **Custom events**: you can freely push custom events based on your specific needs.
* **Support for multi-item data**: information included in the [item](https://community.commandersact.com/platform-x/developers/tracking/events-reference#item) array is dispatched to Piano Analytics.
* **User identifier**: you can openly select a user identifier field for logged users.
* **Send all properties**: send all your event properties to Piano Analytics with a single click.

## Destination setup

Before you get started with this destination, ensure you have access to [Piano Analytics](https://developers.atinternet-solutions.com/piano-analytics/#what-is-piano-analytics).

{% hint style="info" %}
The client-side unique visitor identifier is recommended and is retrieved by getting the value of the [**`_pcid`**](https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/cookie-storage#since-670) **,** [**`pa_vid`**](https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/cookie-storage#piano-analytics-mobile-sdks) , [**`atuserid`**](https://developers.atinternet-solutions.com/piano-analytics/data-collection/general/cookie-storage#legacy-cookie-management) , or <mark style="color:blue;">**`xtidc`**</mark> cookie in this priority order.
{% endhint %}

### Configuration

<table><thead><tr><th width="347">Settings</th><th>Description</th></tr></thead><tbody><tr><td><code>Side Id</code></td><td><em><strong><code>Required</code></strong></em> <br>The identifier of the site the data belongs to (E.g. <code>628087</code>). This can be found in the Piano Analytics interface following <img src="../../../../.gitbook/assets/1 (3).png" alt=""> ➜ <code>SETTINGS</code> ➜ <code>Data Collection Portal</code> ➜ <code>Tools</code> ➜ <code>Site Management</code> and selecting your site.  This setting supports dynamic values <strong>[1].</strong></td></tr><tr><td><code>Secured Collection Domain</code></td><td><em><strong><code>Required</code></strong></em><br>The SSL Domain on which information is collected (E.g. <code>logs1412.xiti.com</code>). This can be found in Piano Analytics interface following <img src="../../../../.gitbook/assets/1 (3).png" alt=""> ➜ <code>SETTINGS</code><br><code>Data Collection Portal</code> ➜ <code>Tools</code> ➜ <code>Site Management</code> and selecting your site.</td></tr><tr><td><code>User Identifier</code></td><td>You can set your user identifier for logged users. More details are available following this <a href="https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api#users">LINK</a>.</td></tr><tr><td><code>Custom Property</code></td><td>When selecting "[Custom Property]" as value for the above <code>User Identifier</code>, this field will show up so you can specify a custom field holding the value for the user identifier <strong>[2]</strong>.</td></tr><tr><td><code>Client Identifier</code></td><td>You can set a specific client identifier as our <code>context.device.sdk_id</code> or a custom property holding its value. When keeping the "Default" value, or the first mentioned options don't result in a valid value, this is your client-side unique visitor identifier from cookies as detailed in the <a href="at-internet.md#destination-setup">Destination setup</a>. If no cookie is available, the property <code>user.tcId</code> is used. More details are available following this <a href="https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api#pattern-1">LINK</a>.</td></tr><tr><td><code>Custom Property</code></td><td>When selecting "[Custom Property]" as value for the above <code>Client Identifier</code>, this field will show up so you can specify a custom field holding the value for the client identifier <strong>[2]</strong>.</td></tr><tr><td><code>Custom Event Mapping: "view_item" matched with Piano "product.page_display"</code></td><td>Flagging this option will match your <code>view_item</code> event with Piano <code>product.page_display</code> event. See <a href="at-internet.md#quick-reference">Quick reference</a> for more information on event mapping.</td></tr><tr><td><code>Send All Properties</code></td><td>When activating this option all properties included in the root of your Commanders Act events are also sent to Piano Analytics in the <code>data</code> object. More details are available following this <a href="https://developers.atinternet-solutions.com/piano-analytics/data-collection/how-to-send-events/collection-api#event-object">LINK</a>.</td></tr><tr><td><code>Custom Event Properties</code></td><td>Map your custom event properties by setting their field names in <code>Event property name</code> and adding the field name holding the value in <code>Commanders Act event property or static value</code> . E.g. if you input<code>size</code>in the  <code>Event property name</code>  and  <code>items.0.product.size</code>  in  <code>Commanders Act event property or static value</code>  , you'll have a custom event property in Piano Analytics called <code>size</code> with a value based on the content of the field  <code>items.0.product.size</code>  <strong>[2]</strong>. You also have the option to set a static string/numeric value in  <code>Commanders Act event property or static value</code> .<br><br>To ensure that custom event properties are picked up by Piano Analytics, you need to create them first by following <img src="../../../../.gitbook/assets/1 (3).png" alt=""> ➜ <code>SETTINGS</code> ➜ <code>Data Management</code> ➜ <code>Data Model</code> ➜ <code>Properties</code> .</td></tr><tr><td><code>Custom User Properties</code></td><td><p>Map your custom user properties by setting their field names in <code>User property name</code> and adding the field name holding the value in  <code>Commanders Act event property or static value</code> .<br>E.g. if you input <code>customer_zipcode</code> in  <code>User property name</code>  and  <code>user.zipcode</code>  <strong>[2]</strong> in  <code>Commanders Act event property or static value</code> , you will have a custom user property in Piano Analytics called <code>customer_zipcode</code> with a value based on the content of the field  <code>user.zipcode</code> . You also have the option to set a static string/numeric value in  <code>Commanders Act event property or static value</code> .<br></p><p>To ensure that custom user properties are picked up by Piano Analytics, you need to create them first by following <img src="../../../../.gitbook/assets/1 (3).png" alt=""> ➜ <code>SETTINGS</code> ➜ <code>Data Management</code> ➜ <code>Data Model</code> ➜ <code>Properties</code> .</p></td></tr></tbody></table>

{% hint style="info" %}
**\[1]** This feature allows you to set an event property holding a dynamic value by adding two open braces ( `{{` ) in front of your property name and two close braces ( `}}` ) at the end (E.g. `{{myEventPropertyPathAndName}}` ).\
**\[2]** Using "dots" (".") you can navigate deeper to the specific field you want to get the value of. See [Events reference](https://community.commandersact.com/platform-x/developers/tracking/events-reference) for more details on the standard field names by event. You can also freely set custom fields: there are no boundaries.
{% endhint %}

## Quick reference

{% hint style="info" %}
[Piano Analytics video/audio](https://developers.atinternet-solutions.com/piano-analytics-tagging-en/event-tagging-piano-analytics-en/standard-event-tagging-en/#audio-video\_31) events are supported by [our event model](https://doc.commandersact.com/developers/tracking/events-reference/video-event-reference).
{% endhint %}

| Commanders Act Events                                                                                                                                                     | Piano Analytics Events                                                                                                |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- |
| `add_payment_info`                                                                                                                                                        | `cart.payment`                                                                                                        |
| `add_shipping_info`                                                                                                                                                       | `cart.delivery`                                                                                                       |
| `add_to_cart`                                                                                                                                                             | `product.add_to_cart`                                                                                                 |
| `add_to_wishlist`                                                                                                                                                         | `product.add_to_wishlist` **\[\*]**                                                                                   |
| `begin_checkout`                                                                                                                                                          | `cart.begin_checkout` **\[\*]**                                                                                       |
| `generate_lead`                                                                                                                                                           | `generate_lead` **\[\*]**                                                                                             |
| `login`                                                                                                                                                                   | `user.login` **\[\*]**                                                                                                |
| `page_view`                                                                                                                                                               | `page.display` or `product.page_display` **\[1]**                                                                     |
| `purchase`                                                                                                                                                                | `transaction.confirmation` and `product.purchased` **\[2]**                                                           |
| `refund`                                                                                                                                                                  | `refund` **\[\*]**                                                                                                    |
| `remove_from_cart`                                                                                                                                                        | `product.remove_from_cart`                                                                                            |
| `search`                                                                                                                                                                  | `internal_search_result.display`                                                                                      |
| `select_content`                                                                                                                                                          | `select_content` **\[\*]**                                                                                            |
| `select_item`                                                                                                                                                             | `page.select_item` **\[\*]**                                                                                          |
| `sign_up`                                                                                                                                                                 | `user.sign_up` **\[\*]**                                                                                              |
| <p><code>video_ad_complete</code> </p><p><code>video_ad_stop</code></p><p><code>video_complete</code></p><p><code>video_content_complete</code></p>                       | `av.stop`                                                                                                             |
| `video_ad_click`                                                                                                                                                          | `av.ad.click`                                                                                                         |
| <p><code>video_ad_playing</code></p><p><code>video_content_playing</code></p><p><code>video_ad_break_complete</code></p><p><code>video_content_quarter_reached</code></p> | `av.heartbeat`                                                                                                        |
| <p><code>video_content_start</code></p><p><code>video_ad_start</code></p><p><code>video_ad_break_start</code></p>                                                         | `av.start`                                                                                                            |
| `video_ad_skip`                                                                                                                                                           | `av.ad.skip`                                                                                                          |
| `video_buffer_start`                                                                                                                                                      | `av.buffer.start`                                                                                                     |
| `video_buffer_complete`                                                                                                                                                   | `av.buffer.heartbeat`                                                                                                 |
| `video_error`                                                                                                                                                             | `av.error`                                                                                                            |
| `video_fullscreen_off`                                                                                                                                                    | `av.fullscreen.off`                                                                                                   |
| `video_fullscreen_on`                                                                                                                                                     | `av.fullscreen.on`                                                                                                    |
| `video_pause`                                                                                                                                                             | `av.pause`                                                                                                            |
| `video_quality`                                                                                                                                                           | `av.quality`                                                                                                          |
| `video_resume`                                                                                                                                                            | `av.resume`                                                                                                           |
| `video_seek_start`                                                                                                                                                        | `av.seek.start`                                                                                                       |
| `video_share`                                                                                                                                                             | `av.share`                                                                                                            |
| `video_speed`                                                                                                                                                             | `av.speed`                                                                                                            |
| `video_start`                                                                                                                                                             | `av.play`                                                                                                             |
| `video_subtitle_off`                                                                                                                                                      | `av.subtitle.off`                                                                                                     |
| `video_subtitle_on`                                                                                                                                                       | `av.subtitle.on`                                                                                                      |
| `video_volume`                                                                                                                                                            | `av.volume`                                                                                                           |
| `view_cart`                                                                                                                                                               | `cart.display`                                                                                                        |
| `view_item`                                                                                                                                                               | <p><code>product.display</code> <strong>[3]</strong></p><p><code>product.page_display</code> <strong>[3]</strong></p> |
| `view_item_list`                                                                                                                                                          | `page.view_item_list` **\[\*]**                                                                                       |
| `[Any Other Event]`                                                                                                                                                       | `[Custom Event]` **\[\*]**                                                                                            |



{% hint style="info" %}
**\[\*]** Custom events must be added to the Piano Analytics' data model first or they won't be processed. You can add new events by following ![](<../../../../.gitbook/assets/1 (3).png>) ➜ `SETTINGS` ➜ `Data Management` ➜ `Data Model` ➜`Events`.\
**\[1]** If <mark style="color:blue;">`page_type`</mark> is equal to <mark style="color:blue;">`product`</mark> then <mark style="color:blue;">`product.page_display`</mark> is sent, otherwise, <mark style="color:blue;">`page.display`</mark> .\
**\[2]** A <mark style="color:blue;">`product.purchased`</mark> will be sent for each product being purchased.\
**\[3]** Flagging <mark style="color:blue;">`Custom Event Mapping: "view_item" matched with Piano "product.page_display"`</mark> (See [Destination setup](at-internet.md#destination-setup)) maps your <mark style="color:blue;">`view_item`</mark> with Piano  <mark style="color:blue;">`product.page_display`</mark> , otherwise your event will be matched with Piano  <mark style="color:blue;">`product.display`</mark> .
{% endhint %}

## Field mappings

| Commanders Act Properties                                                                                                                                             | Piano Analytics Properties                                                                                      |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| `page_name`                                                                                                                                                           | `page`                                                                                                          |
| `value`                                                                                                                                                               | <p><code>generate_lead_value</code></p><p><code>cart_turnovertaxincluded</code></p>                             |
| `currency`                                                                                                                                                            | <p><code>generate_lead_currency</code></p><p><code>cart_currency</code></p>                                     |
| `id`                                                                                                                                                                  | <p><code>transaction_id</code></p><p><code>generate_lead_id</code></p>                                          |
| `item_list_name`                                                                                                                                                      | `view_item_list_name`                                                                                           |
| `method`                                                                                                                                                              | <p><code>login_method</code></p><p><code>sign_up_method</code></p>                                              |
| `search_term`                                                                                                                                                         | `ise_keyword`                                                                                                   |
| `items.X.id`                                                                                                                                                          | `product_id` **\[1]**                                                                                           |
| `items.X.product.name`                                                                                                                                                | `product` **\[1]**                                                                                              |
| `items.X.variant`                                                                                                                                                     | `product_variant` **\[1]**                                                                                      |
| `items.X.product.brand`                                                                                                                                               | `product_brand` **\[1]**                                                                                        |
| `(items.X.discount > 0)`                                                                                                                                              | `product_discount` **\[1]\[2]**                                                                                 |
| `items.X.product.price`                                                                                                                                               | `product_pricetaxincluded` **\[1]**                                                                             |
| `items.X.product.currency`                                                                                                                                            | `product_currency` **\[1]**                                                                                     |
| `items.X.product.category_1`                                                                                                                                          | `product_category1` **\[1]**                                                                                    |
| `items.X.product.category_2`                                                                                                                                          | `product_category2` **\[1]**                                                                                    |
| `items.X.product.category_3`                                                                                                                                          | `product_category3` **\[1]**                                                                                    |
| `items.X.product.category_4`                                                                                                                                          | `product_category4` **\[1]**                                                                                    |
| `items.X.quantity`                                                                                                                                                    | <p><code>product_quantity</code> <strong>[1]</strong></p><p><code>cart_quantity</code> <strong>[3]</strong></p> |
| `items.X.coupon`                                                                                                                                                      | `product_promocode` **\[1]**                                                                                    |
| `coupon`                                                                                                                                                              | `transaction_promocode`                                                                                         |
| `payment_method`                                                                                                                                                      | `payment_mode`                                                                                                  |
| `shipping_amount`                                                                                                                                                     | `shipping_costtaxincluded`                                                                                      |
| `shipping_tier`                                                                                                                                                       | `shipping_delivery`                                                                                             |
| `cart_id`                                                                                                                                                             | `cart_id`                                                                                                       |
| `revenue`                                                                                                                                                             | `cart_turnovertaxfree`                                                                                          |
| `items.length`                                                                                                                                                        | `cart_nbdistinctproduct`                                                                                        |
| <p><code>user.id</code></p><p><code>user.email</code></p><p><code>user.email_md5</code></p><p><code>user.email_sha256</code></p><p><code>[custom_property]</code></p> | `user_id` **\[4]**                                                                                              |
| `context.device.manufacturer`                                                                                                                                         | `device_manufacturer`                                                                                           |
| `context.device.model`                                                                                                                                                | `device_model`                                                                                                  |
| `context.device.screen.height`                                                                                                                                        | `device_screen_height`                                                                                          |
| `context.device.screen.width`                                                                                                                                         | `device_screen_width`                                                                                           |
| `content_asset_id`                                                                                                                                                    | `av_content_id` **\[5]**                                                                                        |
| `video_session_id`                                                                                                                                                    | `av_session_id`                                                                                                 |
| `cursor_position * 1000`                                                                                                                                              | `av_position`                                                                                                   |
| `prev_cursor_position * 1000`                                                                                                                                         | `av_previous_position`                                                                                          |
| `time_prev_event`                                                                                                                                                     | `av_duration`                                                                                                   |
| `prev_event_name`                                                                                                                                                     | `av_previous_event`                                                                                             |
| `video_title`                                                                                                                                                         | `av_content`                                                                                                    |
| `video_category`                                                                                                                                                      | `av_content_type`                                                                                               |
| `total_length * 1000`                                                                                                                                                 | `av_content_duration`                                                                                           |
| `content_linked`                                                                                                                                                      | `av_content_linked`                                                                                             |
| `airdate`                                                                                                                                                             | `av_publication_date`                                                                                           |
| `keywords`                                                                                                                                                            | `av_content_genre`                                                                                              |
| `program`                                                                                                                                                             | `av_show`                                                                                                       |
| `season`                                                                                                                                                              | `av_show_season`                                                                                                |
| `episode`                                                                                                                                                             | `av_episode_id`                                                                                                 |
| `episode_label`                                                                                                                                                       | `av_episode`                                                                                                    |
| `channel`                                                                                                                                                             | `av_channel`                                                                                                    |
| `publisher`                                                                                                                                                           | `av_author`                                                                                                     |
| `content_version`                                                                                                                                                     | `av_content_version`                                                                                            |
| `content_duration_range`                                                                                                                                              | `av_content_duration_range`                                                                                     |
| `(livestream)`                                                                                                                                                        | `av_broadcasting_type` **\[6]**                                                                                 |
| `broadcaster_name`                                                                                                                                                    | `av_broadcaster`                                                                                                |
| `ad_type`                                                                                                                                                             | `av_ad_type`                                                                                                    |
| `video_player`                                                                                                                                                        | `av_player`                                                                                                     |
| `video_player_version`                                                                                                                                                | `av_player_version`                                                                                             |
| `auto_play`                                                                                                                                                           | `av_auto_mode`                                                                                                  |
| `video_language`                                                                                                                                                      | `av_language`                                                                                                   |
| `video_subtitles_language`                                                                                                                                            | `av_subtitles`                                                                                                  |
| `video_launch_reason`                                                                                                                                                 | `av_launch_reason`                                                                                              |
| `interruption_method`                                                                                                                                                 | `av_player_error`                                                                                               |
| `seek_position`                                                                                                                                                       | `av_seek_position`                                                                                              |
| `bitrate`                                                                                                                                                             | `av_bitrate`                                                                                                    |
| `framerate`                                                                                                                                                           | `av_framerate`                                                                                                  |
| `sound`                                                                                                                                                               | `av_sound`                                                                                                      |
| `full_screen`                                                                                                                                                         | `av_fullscreen`                                                                                                 |
| `ad_enabled`                                                                                                                                                          | `av_ad_enabled`                                                                                                 |
| `image_quality`                                                                                                                                                       | `av_image_quality`                                                                                              |
| <p><code>content_pod_id</code></p><p><code>ad_pod_id</code></p>                                                                                                       | `av_pod_id` **\[5]**                                                                                            |
| `video_description`                                                                                                                                                   | `av_description`                                                                                                |
| `full_episode`                                                                                                                                                        | `av_full_episode`                                                                                               |

{% hint style="info" %}
**\[1]** Field included for the following events: <mark style="color:blue;">`add_to_cart`</mark> , <mark style="color:blue;">`page_view (product.page_display)`</mark> , <mark style="color:blue;">`view_item`</mark> , <mark style="color:blue;">`purchase (product.purchased)`</mark> ,  <mark style="color:blue;">`remove_from_cart`</mark> , <mark style="color:blue;">`add_to_wishlist`</mark> , and <mark style="color:blue;">`select_item`</mark> .\
**\[2]** Boolean value: <mark style="color:blue;">`true`</mark> or <mark style="color:blue;">`false`</mark> .\
**\[3]** Sum all <mark style="color:blue;">`items.X.quantity`</mark> .\
**\[4]** Depending on the drop-down selection (See <mark style="color:blue;">`User Identifier`</mark> in the[<mark style="color:blue;">`Configuration`</mark>](at-internet.md#configuration)section), a specific Commanders Act property is used.\
**\[5]** Field converted to string.\
**\[6]** This is either "Live" or "Recorded Broadcast".
{% endhint %}

#### Headers parameters

| Commanders Act Properties | Piano Analytics Fields |
| ------------------------- | ---------------------- |
| `device.user_agent`       | `User-Agent`           |
| `page.location`           | `Referer`              |
| `device.ip`               | `X-Forwarded-For`      |
